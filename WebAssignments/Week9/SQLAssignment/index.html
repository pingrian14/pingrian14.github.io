<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Disney Songs SQL Engine</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
    body {
        background: #C2F2DB;
        color:rgb(71, 71, 71);
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 20px;
    }

    .box {
        background: white;
        width: 80%;
        padding: 25px;
        border-radius: 15px;
        margin: 20px 0;
        border: 2px solid #ccc;
        box-shadow: 0px 4px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .left {
        text-align: left;
    }

    .underline {
            width:100%;
            height: 0.5px;
            background-color:#ccc;
        }

    .two-col {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 15px;
    }

    input {
        padding: 8px;
        width: 45%;
        border-radius: 8px;
        border: 1px solid #999;
    }

    textarea {
        width: 80%;
        padding: 10px;
        height: 120px;
        border-radius: 10px;
        border: 1px solid #888;
        resize: none;
        margin-bottom: 10px;
    }

    button {
        margin: 6px;
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        background: #46eb6b;
        transition: 0.15s;
        cursor: pointer;
        font-weight: bold;
    }

    button:hover {
        background: #71F59C;
        transform: translateY(-3px);
    }

    button:active {
        transform: translateY(2px) scale(0.95);
    }

    .clearButton {
        margin: 6px;
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        background: #5A9BC8;
        transition: 0.15s;
        cursor: pointer;
        font-weight: bold;
    }

    .clearButton:hover {
        background: #73bcf0;
        transform: translateY(-3px);
    }

    .clearButton:active {
        transform: translateY(2px) scale(0.95);
    }

    .exampleButton {
        margin: 6px;
        padding: 10px 18px;
        border-radius: 10px;
        border: none;
        background: #4ADE80;
        transition: 0.15s;
        cursor: pointer;
        font-weight: bold;
    }

    .exampleButton:hover {
        background: #71F59C;
        transform: translateY(-3px);
    }

    .exampleButton:active {
        transform: translateY(2px) scale(0.95);
    }

    table {
        margin: auto;
        border-collapse: collapse;
        width: 90%;
        background: #ffffff;

        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); /* soft shadow */
        border-radius: 6px;
        overflow: hidden;
    }

    th, td {
        border: 1px solid #aaa;
        padding: 6px;
    }

    th {
        background-color: #3e5f77; /* dark blue-gray #34495e*/
        color: white;
        padding: 12px 10px;
        text-align: left;
        font-size: 15px;
        letter-spacing: 0.5px;
    }

    tbody td {
        padding: 10px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
    }

    tbody tr:hover {
        background-color: #f5f7fa; /* light hover effect */
    }

    tbody tr:nth-child {
        background-color: #fbfbfb; /* subtle alternating rows */
    }
    

    #output {
        min-height: 150px;
        padding: 15px;
        /* background: #F7FFF3; */
        border-radius: 10px;
        /* border: 1px solid #aaa; */
        width: 90%;
        margin-top: 15px;
    }

    #output-container {
        max-height: 350px;       /* Adjust how tall you want the box */
        overflow-y: auto;        /* Vertical scroll */
        overflow-x: auto;        /* Horizontal scroll for wide tables */
        margin-top: 15px;
        width: 90%;
        background: #f8f8f8;
        border: 1px solid #aaa;
        border-radius: 10px;
        padding: 10px;
    }

</style>
</head>
<body>

<!-- ================= SONG INPUT BOX ================= -->
<div class="box">
    <h2 class="left">Songs of Animated Disney Films</h2>
    <p class="left">Add songs manually below. Make sure each field is filled properly.</p>
    <p class="underline"></p>

    <div class="two-col">
        <input id="id" placeholder="Song ID">
        <input id="song" placeholder="Song Title">
    </div>

    <div class="two-col">
        <input id="movie" placeholder="Movie">
        <input id="length" placeholder="Song Length">
    </div>

    <div class="two-col">
        <input id="release" placeholder="Release Number">
        <input id="year" placeholder="Year">
    </div>

    <input style="width: 50%" id="streams" placeholder="Streams"><br>

    <button onclick="addSong()">Submit</button>
</div>

<!-- ================= CSV IMPORT BOX ================= -->
<div class="box">
    <h2 class="left">Import CSV File</h2>
    <p class="left">Ensure the first row contains: id, song, movie, song_length, release_number, year, streams</p>
    <p class="underline"></p>

    <input type="file" id="csvFile">
    <button onclick="importCSV()">Import</button>
    <button onclick="clearTable()" class="clearButton">Clear Table</button>
</div>

<!-- ================= SQL CONSOLE ================= -->
<div class="box">
    <h2 class="left">SQL Console</h2>
    <p class="underline"></p>

    <textarea id="sqlBox" placeholder="Enter SQL query here..."></textarea><br>

    <div>
        <button onclick="insertExample('SELECT * FROM songs WHERE year < 2000;')" class="exampleButton">Example 1</button>
        <button onclick="insertExample('SELECT song, movie, streams FROM songs ORDER BY streams DESC;')" class="exampleButton">Example 2</button>
        <button onclick="insertExample('SELECT song, movie, song_length, year, streams FROM songs WHERE release_number IS 50;')" class="exampleButton">Example 3</button>
        <button onclick="insertExample('SELECT song, release_number, song_length, streams FROM songs WHERE song_length BETWEEN \'2:00\' AND \'3:59\' ORDER BY streams DESC;')" class="exampleButton">Example 4</button>
        <button onclick="insertExample('SELECT DISTINCT movie, release_number, year FROM songs WHERE movie LIKE \'The%\' ORDER BY release_number;')" class="exampleButton">Example 5</button>
        <button onclick="insertExample('SELECT song, movie, year FROM songs WHERE streams > 500000000 ORDER BY streams;')" class="exampleButton">Example 6</button>
        <button onclick="insertExample('SELECT movie, year, MIN(streams) AS lowest_streams, MAX(streams) AS highest_streams, ROUND(AVG(streams), 2) AS avg_streams FROM songs WHERE movie IS \'Frozen\';')" class="exampleButton">Aggregate 1</button>
    </div>

    <button onclick="runSQL()">Run SQL</button>
    <button onclick="document.getElementById('sqlBox').value=''" class="clearButton">Clear SQL</button>

    <div id="output-container">
        <div id="output">Run an SQL query to view results.</div>
    </div>
    
</div>

<script>
let db;

// ================= INIT SQLITE =================
initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` })
.then(SQL => {
    db = new SQL.Database();
    db.run(`
        CREATE TABLE songs (
            id INTEGER PRIMARY KEY,
            song TEXT,
            movie TEXT,
            song_length TEXT,
            release_number INTEGER,
            year INTEGER,
            streams INTEGER
        );
    `);
});

// ================= SANITIZE STREAM VALUE =================
function cleanStreams(value) {
    if (value === null || value === undefined) return 0;

    // Remove everything that is not a digit (handles spaces, invisible chars, commas, unicode)
    let cleaned = (value + "").replace(/[^\d]/g, "");

    return parseInt(cleaned) || 0;
}

// ================= ADD SONG MANUALLY =================
function addSong() {
    let id = document.getElementById("id").value.trim();
    let song = document.getElementById("song").value.trim();
    let movie = document.getElementById("movie").value.trim();
    let length = document.getElementById("length").value.trim();
    let release = document.getElementById("release").value.trim();
    let year = document.getElementById("year").value.trim();
    let streamsRaw = document.getElementById("streams").value.trim();

    if (!id || !release || !year || isNaN(id) || isNaN(release) || isNaN(year)) {
        alert("Song ID, Release Number, Year, and Streams must be numeric.");
        return;
    }

    let streams = cleanStreams(streamsRaw);

    try {
        db.run(
            `INSERT INTO songs VALUES (?, ?, ?, ?, ?, ?, ?)`,
            [id, song, movie, length, release, year, streams]
        );
        alert("Song added successfully!");
    } catch (err) {
        alert("Error: Song ID must be unique.");
    }
}

// ================= IMPORT CSV (FULLY CLEANED) =================
function importCSV() {
    let file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Please choose a CSV file.");

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
        complete: function(results) {

            let rows = results.data;

            const requiredHeaders = [
                "id", "song", "movie", "song_length",
                "release_number", "year", "streams"
            ];

            let csvHeaders = Object.keys(rows[0] || {});

            for (let h of requiredHeaders) {
                if (!csvHeaders.includes(h)) {
                    alert("CSV missing required column: " + h);
                    return;
                }
            }

            // Clear old data
            db.run("DELETE FROM songs;");

            try {
                rows.forEach(r => {
                    if (!r.id || !r.release_number || !r.year) return;

                    db.run(
                        `INSERT INTO songs VALUES (?, ?, ?, ?, ?, ?, ?)`,
                        [
                            parseInt(r.id),
                            r.song?.trim(),
                            r.movie?.trim(),
                            r.song_length?.trim(),
                            parseInt(r.release_number),
                            parseInt(r.year),
                            cleanStreams(r.streams)
                        ]
                    );
                });

                alert("CSV Imported Successfully!");
            } catch (err) {
                alert("Import Error: " + err);
            }
        }
    });
}

// ================= CLEAR TABLE =================
function clearTable() {
    if (confirm("Are you sure you want to delete all songs?")) {
        db.run("DELETE FROM songs;");
        alert("Table cleared.");
    }
}

// ================= SQL EXAMPLES =================
function insertExample(text) {
    document.getElementById("sqlBox").value = text;
}

// ================= RUN SQL =================
function runSQL() {
    let query = document.getElementById("sqlBox").value.trim();
    let output = document.getElementById("output");

    if (!query) {
        output.innerHTML = "Enter an SQL query first.";
        return;
    }

    try {
        let res = db.exec(query);
        if (res.length === 0) {
            output.innerHTML = "Query executed successfully. No rows returned.";
            return;
        }

        let table = `<table><tr>`;
        res[0].columns.forEach(c => table += `<th>${c}</th>`);
        table += `</tr>`;

        res[0].values.forEach(row => {
            table += `<tr>`;
            row.forEach(v => table += `<td>${v}</td>`);
            table += `</tr>`;
        });

        table += `</table>`;
        output.innerHTML = table;

    } catch (err) {
        output.innerHTML = `<span style='color:red'>${err}</span>`;
    }
}
</script>

</body>
</html>

